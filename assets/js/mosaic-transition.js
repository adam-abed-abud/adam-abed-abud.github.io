class MosaicTransition{constructor(){this.overlay=null,this.tiles=[],this.isTransitioning=!1,this.init()}init(){parseInt(getComputedStyle(document.documentElement).getPropertyValue("--mosaic-enabled"))&&(window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches||(this.ROWS=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--mosaic-rows")),this.COLS=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--mosaic-cols")),this.DURATION=parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--mosaic-duration")),this.COVER_PERCENTAGE=parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--mosaic-cover-percentage")),this.createOverlay(),this.buildGrid(),this.interceptNavigation(),this.setupCleanup()))}createOverlay(){this.overlay=document.createElement("div"),this.overlay.id="mosaic-transition",this.overlay.className="mosaic-transition",this.overlay.setAttribute("aria-hidden","true"),document.body.appendChild(this.overlay)}buildGrid(){this.overlay.innerHTML="",this.tiles=[];for(let e=0;e<this.ROWS;e++)for(let e=0;e<this.COLS;e++){const e=document.createElement("div");e.className="mosaic-tile",this.tiles.push(e),this.overlay.appendChild(e)}}chooseActiveTiles(){const e=.8*this.DURATION;this.tiles.forEach(t=>{t.classList.remove("active"),t.style.transitionDelay=Math.round(Math.random()*e)+"ms"});const t=this.tiles.length,i=[...this.tiles.keys()];for(let e=i.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[i[e],i[t]]=[i[t],i[e]]}for(let e=0;e<t;e++)this.tiles[i[e]].classList.add("active");return t}async performTransition(e){if(this.isTransitioning)return;this.isTransitioning=!0,this.chooseActiveTiles(),this.overlay.classList.remove("revealing"),this.overlay.classList.add("covering");const t=this.tiles.filter(e=>e.classList.contains("active")),i=t.length?Math.max(...t.map(e=>parseFloat(e.style.transitionDelay))):0;await new Promise(e=>setTimeout(e,this.DURATION+i+30));const s={activeTiles:Array.from(this.tiles).map((e,t)=>({index:t,active:e.classList.contains("active"),delay:e.style.transitionDelay})),timestamp:Date.now()};sessionStorage.setItem("mosaic-covering-state",JSON.stringify(s)),window.location.href=e}async performReveal(){this.chooseActiveTiles(),this.overlay.classList.remove("covering"),this.overlay.classList.add("revealing");const e=this.tiles.filter(e=>e.classList.contains("active")),t=e.length?Math.max(...e.map(e=>parseFloat(e.style.transitionDelay))):0;await new Promise(e=>setTimeout(e,this.DURATION+t+30)),this.overlay.classList.remove("revealing"),this.isTransitioning=!1}forceCleanup(){this.overlay&&(this.overlay.classList.remove("covering","revealing"),this.overlay.classList.add("force-cleanup"),this.isTransitioning=!1,this.tiles.forEach(e=>{e.classList.remove("active"),e.style.transitionDelay=""}),setTimeout(()=>{this.overlay&&this.overlay.classList.remove("force-cleanup")},150))}setupCleanup(){window.addEventListener("beforeunload",()=>{this.forceCleanup()}),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&this.forceCleanup()}),window.addEventListener("focus",()=>{setTimeout(()=>{!this.isTransitioning&&this.overlay.classList.contains("covering")&&this.forceCleanup()},100)})}updateTheme(){const e="dark"===document.documentElement.getAttribute("data-theme")||document.documentElement.classList.contains("dark"),t=getComputedStyle(document.documentElement).getPropertyValue("--mosaic-cover-color").trim();["#4a5df8","#4a5df8","#4a5df8"].includes(t)&&(e?document.documentElement.style.setProperty("--mosaic-cover-color","#4a5df7"):document.documentElement.style.setProperty("--mosaic-cover-color","#4a5df8"))}interceptNavigation(){document.addEventListener("click",e=>{const t=e.target.closest("a");if(!t)return;const i=t.getAttribute("href");i&&(i.startsWith("http")||i.startsWith("mailto:")||i.startsWith("tel:")||i.startsWith("#")||"_blank"===t.target||t.hasAttribute("download")||t.getAttribute("data-toggle")||"search-toggle"===t.id||"light-toggle"===t.id||t.classList.contains("dropdown-toggle")||t.hasAttribute("data-bs-toggle")||t.closest("form")||t.getAttribute("onclick")||t.classList.contains("figure-link")||t.hasAttribute("data-zoomable-image")||(e.preventDefault(),this.performTransition(i)))}),window.addEventListener("popstate",()=>{this.forceCleanup(),setTimeout(()=>{this.isTransitioning||this.performReveal()},50)})}}document.addEventListener("DOMContentLoaded",()=>{window.mosaicTransition=new MosaicTransition,window.mosaicTransition.updateTheme(),new MutationObserver(()=>{window.mosaicTransition.updateTheme()}).observe(document.documentElement,{attributes:!0,attributeFilter:["data-theme","class"]});const e=sessionStorage.getItem("mosaic-covering-state");if(e&&document.referrer&&document.referrer.includes(window.location.hostname))try{const i=JSON.parse(e);Date.now()-i.timestamp<5e3?(window.mosaicTransition.overlay.classList.add("covering"),i.activeTiles.forEach(e=>{if(window.mosaicTransition.tiles[e.index]){const t=window.mosaicTransition.tiles[e.index];e.active&&t.classList.add("active"),t.style.transitionDelay=e.delay}}),sessionStorage.removeItem("mosaic-covering-state"),setTimeout(()=>{window.mosaicTransition.performReveal()},100)):(sessionStorage.removeItem("mosaic-covering-state"),window.mosaicTransition.forceCleanup())}catch(t){sessionStorage.removeItem("mosaic-covering-state"),window.mosaicTransition.forceCleanup()}else document.referrer&&document.referrer.includes(window.location.hostname)?setTimeout(()=>{window.mosaicTransition.performReveal()},100):setTimeout(()=>{window.mosaicTransition.forceCleanup()},100)}),window.addEventListener("load",()=>{window.mosaicTransition&&window.mosaicTransition.overlay&&window.mosaicTransition.overlay.classList.contains("covering")&&!window.mosaicTransition.isTransitioning&&window.mosaicTransition.forceCleanup()}),window.addEventListener("pageshow",e=>{e.persisted&&window.mosaicTransition&&setTimeout(()=>{window.mosaicTransition.forceCleanup()},50)}),setTimeout(()=>{if(window.mosaicTransition&&window.mosaicTransition.overlay){window.mosaicTransition.overlay.classList.contains("covering")&&!window.mosaicTransition.isTransitioning&&window.mosaicTransition.forceCleanup()}},2e3);