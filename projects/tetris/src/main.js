function Tetris(e){this.id=e,this.init()}var utils=require("./utils.js"),consts=require("./consts.js"),shapes=require("./shapes.js"),views=require("./views.js"),canvas=require("./canvas.js"),initMatrix=function(e,t){for(var i=[],s=0;s<e;s++){var r=[];i.push(r);for(var a=0;a<t;a++)r.push(0)}return i},clearMatrix=function(e){for(var t=0;t<e.length;t++)for(var i=0;i<e[t].length;i++)e[t][i]=0},checkFullRows=function(e){for(var t=[],i=0;i<e.length;i++){for(var s=e[i],r=!0,a=0;a<s.length;a++)r=r&&0!==s[a];r&&t.push(i)}return t},removeOneRow=function(e,t){for(var i=e[0].length,s=t;s>=0;s--)for(var r=0;r<i;r++)e[s][r]=s>0?e[s-1][r]:0},removeRows=function(e,t){for(var i in t)removeOneRow(e,t[i])},checkGameOver=function(e){for(var t=e[0],i=0;i<t.length;i++)if(0!==t[i])return!0;return!1},calcRewards=function(e){return e&&e.length>1?100*Math.pow(2,e.length-1):0},calcScore=function(e){return e&&e.length?100*e.length:0},calcIntervalByLevel=function(e){return consts.DEFAULT_INTERVAL-60*(e-1)},defaults={maxHeight:700,maxWidth:600};Tetris.prototype={init:function(e){var t=this.config=utils.extend(e,defaults);this.interval=consts.DEFAULT_INTERVAL,views.init(this.id,t.maxWidth,t.maxHeight),canvas.init(views.scene,views.preview),this.matrix=initMatrix(consts.ROW_COUNT,consts.COLUMN_COUNT),this.reset(),this._initEvents(),this._fireShape()},reset:function(){this.running=!1,this.isGameOver=!1,this.level=1,this.score=0,this.startTime=(new Date).getTime(),this.currentTime=this.startTime,this.prevTime=this.startTime,this.levelTime=this.startTime,clearMatrix(this.matrix),views.setLevel(this.level),views.setScore(this.score),views.setGameOver(this.isGameOver),this._draw()},start:function(){this.running=!0,window.requestAnimationFrame(utils.proxy(this._refresh,this))},pause:function(){this.running=!1,this.currentTime=(new Date).getTime(),this.prevTime=this.currentTime,views.setPause(!0)},gameOver:function(){this.isGameOver=!0,views.setGameOver(this.isGameOver),this.running=!1},togglePause:function(){return this.running?this.pause():this.isGameOver||(this.start(),views.setPause(!1)),this.running},_keydownHandler:function(e){var t=this.matrix;if(!e)e=window.event;if(80!==e.keyCode){if(!this.isGameOver&&this.shape)switch(e.keyCode){case 37:this.shape.goLeft(t),this._draw();break;case 39:this.shape.goRight(t),this._draw();break;case 38:this.shape.rotate(t),this._draw();break;case 40:this.shape.goDown(t),this._draw();break;case 32:this.shape.goBottom(t),this._update()}}else this.togglePause()},_restartHandler:function(){this.reset(),this.start()},_initEvents:function(){window.addEventListener("keydown",utils.proxy(this._keydownHandler,this),!1),views.btnRestart.addEventListener("click",utils.proxy(this._restartHandler,this),!1)},_fireShape:function(){this.shape=this.preparedShape||shapes.randomShape(),this.preparedShape=shapes.randomShape(),this._draw(),canvas.drawPreviewShape(this.preparedShape)},_draw:function(){canvas.drawScene(),canvas.drawShape(this.shape),canvas.drawMatrix(this.matrix)},_refresh:function(){this.running&&(this.currentTime=(new Date).getTime(),this.currentTime-this.prevTime>this.interval&&(this._update(),this.prevTime=this.currentTime,this._checkLevel()),this.isGameOver||window.requestAnimationFrame(utils.proxy(this._refresh,this)))},_update:function(){this.shape.canDown(this.matrix)?this.shape.goDown(this.matrix):(this.shape.copyTo(this.matrix),this._check(),this._fireShape()),this._draw(),this.isGameOver=checkGameOver(this.matrix),views.setGameOver(this.isGameOver),this.isGameOver&&views.setFinalScore(this.score)},_check:function(){var e=checkFullRows(this.matrix);if(e.length){removeRows(this.matrix,e);var t=calcScore(e),i=calcRewards(e);this.score+=t+i,views.setScore(this.score),views.setReward(i)}},_checkLevel:function(){var e=(new Date).getTime();e-this.levelTime>consts.LEVEL_INTERVAL&&(this.level+=1,this.interval=calcIntervalByLevel(this.level),views.setLevel(this.level),this.levelTime=e)}},window.Tetris=Tetris;